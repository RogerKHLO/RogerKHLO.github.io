<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Session</title>
    <link href="https://fonts.googleapis.com/css2?family=Pirata+One&family=Playfair+Display:wght@400;700;900&family=Cormorant+Garamond:wght@400;600&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="paper">
    
    <div class="head-wrapper">
        <a href="../index.html" style="text-decoration: none; color: inherit;">
            <div style="font-family: var(--font-display); font-weight: bold; margin-bottom: 10px; border-bottom: 1px dotted #333; display: inline-block;">← RETURN TO FRONT PAGE</div>
        </a>
        <header class="masthead" style="font-size: 3rem;">The Chronometer</header>
        <div class="subhead">
            <span>Model #311225</span>
            <span>Focus Mechanism</span>
            <span>Pat. Pending</span>
        </div>
    </div>

    <div class="chronometer-machine">
        
        <div class="machine-headplate">
            <div class="screw tl"><div class="screw-slot"></div></div>
            <div class="screw tr"><div class="screw-slot"></div></div>
            <span style="letter-spacing: 2px; font-weight: bold; font-size: 1.2rem;">MODEL #311225</span>
        </div>

        <div class="machine-body">

            <div class="mode-selector">
                <span class="mode-label">TASK PROTOCOL SELECTOR</span>
                <select id="protocolSelect" class="protocol-select" onchange="updateProtocol()">
                    <option value="pomodoro">STANDARD / STUDY (25/5)</option>
                    <option value="deep" selected>DEEP WORK / CODING (50/10)</option>
                    <option value="flow">FLOW / WRITING (52/17)</option>
                    <option value="ultradian">ULTRADIAN (90/20)</option>
                </select>
            </div>

            <div class="session-manifest">
                <div class="manifest-tape"></div>
                <div class="manifest-row">
                    <span class="manifest-label">SEQUENCE LOG:</span>
                    <span class="manifest-value" id="manifestBlocks">-- BLOCKS</span>
                </div>
                <div class="manifest-row">
                    <span class="manifest-label">CURRENT STRATEGY:</span>
                    <span class="manifest-value break-highlight" id="manifestStrategy">--</span>
                </div>
            </div>

            <div class="clock-stage">
                <div class="clock-glare"></div>
                <svg class="clock-svg" viewBox="0 0 200 200">
                    <g class="clock-face-ticks" id="clockTicks"></g>
                    <line x1="100" y1="100" x2="100" y2="60" class="hand hand-hour" id="handHour" />
                    <line x1="100" y1="100" x2="100" y2="28" class="hand hand-minute" id="handMin" />
                    <line x1="100" y1="100" x2="100" y2="22" class="hand hand-second" id="handSec" />
                    <circle cx="100" cy="100" r="5" class="center-nut"></circle>
                </svg>
            </div>

            <div class="readout-panel">
                <div class="control-group">
                    <button class="btn-adj" id="btnMinus" onclick="adjustTotal(-15)">-</button>
                    <input type="text" id="timeInput" class="time-input" value="120 min">
                    <button class="btn-adj" id="btnPlus" onclick="adjustTotal(15)">+</button>
                </div>
                <div class="status-label" id="statusLabel">TOTAL AVAILABLE TIME</div>
            </div>

            <div class="action-row">
                <button class="btn-main btn-start" id="startBtn">ENGAGE</button>
                <button class="btn-main" id="resetBtn">RESET</button>
                <button class="btn-main btn-skip" id="skipBtn" style="display:none;">SKIP</button>
            </div>

            <div class="quota-section">
                <div class="quota-header">
                    <span>Cumulative Log</span>
                    <span id="dailyText">0 MIN</span>
                </div>
                <div class="bar-container">
                    <div class="bar-fill" id="dailyBar"></div>
                </div>
            </div>

        </div> </div>

    <footer class="footer-section">
        <div style="margin-bottom: 30px;">
        <a href="../log.html" class="footer-nav-link">
            Open Visitor Log ✎
        </a>
        </div>
        <div class="social-links">
            <a href="https://instagram.com/rkhl.ol" target="_blank"><svg class="social-icon" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg></a>
            <a href="https://linkedin.com/in/rogerkhlo" target="_blank"><svg class="social-icon" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg></a>
            <a href="mailto:roger.rlkh@gmail.com"><svg class="social-icon" viewBox="0 0 24 24"><path d="M0 3v18h24v-18h-24zm21.518 2l-9.518 7.713-9.518-7.713h19.036zm-19.518 14v-11.817l10 8.104 10-8.104v11.817h-20z"/></svg></a>
            <a href="https://github.com/rogerkhlo" target="_blank"><svg class="social-icon" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></a>
        </div>
        <div class="copyright">End of Page.
            <a href="#" style="color: var(--ink-red); text-decoration: none; border-bottom: 1px solid var(--ink-red); font-size: 0.8rem; display: inline-block; margin-top: 10px;">
                Return to Masthead ↑
            </a>
        </div>
    </footer>

</div>

<script>
    // --- CONFIG ---
    const MAX_MINUTES = 1020; 
    const DAILY_GOAL = 240; 
    
    // --- STRATEGIES ---
    const PROTOCOLS = {
        'pomodoro': { focus: 25, break: 5, label: "25/5 POMODORO" },
        'deep':     { focus: 50, break: 10, label: "50/10 DEEP WORK" },
        'flow':     { focus: 52, break: 17, label: "52/17 FLOW STATE" },
        'ultradian':{ focus: 90, break: 20, label: "90/20 ULTRADIAN" }
    };

    // --- STATE ---
    let totalSessionGoal = 120; 
    let activeProtocol = 'deep'; 
    let schedule = []; 
    let currentStepIndex = 0;
    
    let currentBlockDuration = 0; 
    let timeLeft = 0;             
    let isRunning = false;
    let timerInterval = null;
    let totalMinutesLogged = 0;

    // --- ELEMENTS ---
    const protocolSelect = document.getElementById('protocolSelect');
    const timeInput = document.getElementById('timeInput');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const skipBtn = document.getElementById('skipBtn');
    const statusLabel = document.getElementById('statusLabel');
    
    const manifestBlocks = document.getElementById('manifestBlocks');
    const manifestStrategy = document.getElementById('manifestStrategy');
    
    const handHour = document.getElementById('handHour');
    const handMin = document.getElementById('handMin');
    const handSec = document.getElementById('handSec');
    const dailyBar = document.getElementById('dailyBar');
    const dailyText = document.getElementById('dailyText');

    // --- INIT ---
    function init() {
        drawClockTicks();
        loadStats();
        
        updateInputDisplay(totalSessionGoal);
        calculateSchedule();
        setHands(0);

        startBtn.addEventListener('click', toggleTimer);
        resetBtn.addEventListener('click', resetSession);
        skipBtn.addEventListener('click', skipBreak);
        
        timeInput.addEventListener('change', handleManualInput);
        timeInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') timeInput.blur(); });
        timeInput.addEventListener('focus', () => { if(!isRunning) timeInput.value = ""; });
        timeInput.addEventListener('blur', () => { if(timeInput.value === "") updateInputDisplay(totalSessionGoal); });
    }

    function drawClockTicks() {
        const group = document.getElementById('clockTicks');
        const cx = 100, cy = 100, r = 90;
        for (let i = 0; i < 60; i++) {
            const angle = (i * 6) * (Math.PI / 180);
            const isMajor = i % 5 === 0;
            const len = isMajor ? 12 : 6;
            const x1 = cx + (r - len) * Math.sin(angle);
            const y1 = cy - (r - len) * Math.cos(angle);
            const x2 = cx + r * Math.sin(angle);
            const y2 = cy - r * Math.cos(angle);
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", x1); line.setAttribute("y1", y1);
            line.setAttribute("x2", x2); line.setAttribute("y2", y2);
            if (isMajor) line.classList.add("major");
            group.appendChild(line);
        }
    }

    function setHands(elapsedSeconds) {
        const secDeg = elapsedSeconds * 6; 
        const minDeg = (elapsedSeconds / 60) * 6; 
        const hourDeg = (elapsedSeconds / 3600) * 30;
        handSec.style.transform = `rotate(${secDeg}deg)`;
        handMin.style.transform = `rotate(${minDeg}deg)`;
        handHour.style.transform = `rotate(${hourDeg}deg)`;
    }

    function formatMinutesToHrMin(m) {
        if (m < 60) return `${m} min`;
        const hr = Math.floor(m / 60);
        const min = m % 60;
        if (min === 0) return `${hr} hr`;
        return `${hr} hr ${min} min`;
    }

    function updateInputDisplay(m) { timeInput.value = formatMinutesToHrMin(m); }
    function formatTime(s) {
        const m = Math.floor(s / 60);
        const sec = s % 60;
        return `${m}:${sec < 10 ? '0' : ''}${sec}`;
    }

    // --- PROTOCOL & SCHEDULE LOGIC ---
    function updateProtocol() {
        activeProtocol = protocolSelect.value;
        calculateSchedule();
    }

    function calculateSchedule() {
        schedule = [];
        const proto = PROTOCOLS[activeProtocol];
        
        let remaining = totalSessionGoal;
        
        while (remaining > 0) {
            if (remaining >= proto.focus) {
                schedule.push({ type: 'focus', duration: proto.focus });
                remaining -= proto.focus;
                if (remaining >= 5) { 
                     let brk = Math.min(proto.break, remaining);
                     schedule.push({ type: 'break', duration: brk });
                     remaining -= brk;
                }
            } else {
                if (remaining > 0) {
                    schedule.push({ type: 'focus', duration: remaining });
                    remaining = 0;
                }
            }
        }
        
        if (schedule.length > 0 && schedule[schedule.length-1].type === 'break') {
             schedule.pop();
        }

        updateManifest();
    }

    function updateManifest() {
        let focusCount = schedule.filter(s => s.type === 'focus').length;
        let breakCount = schedule.filter(s => s.type === 'break').length;
        const proto = PROTOCOLS[activeProtocol];

        manifestBlocks.innerText = `${focusCount} FOCUS BLOCKS`;
        
        if (breakCount > 0) {
            manifestStrategy.innerText = `${proto.label}`;
            manifestStrategy.style.color = "#8a1c1c";
        } else {
            manifestStrategy.innerText = "SINGLE SESSION";
            manifestStrategy.style.color = "#666";
        }
    }

    // --- INPUT ---
    function adjustTotal(amount) {
        if (isRunning) return;
        let val = totalSessionGoal + amount;
        if (val < 15) val = 15;
        if (val > MAX_MINUTES) val = MAX_MINUTES;
        totalSessionGoal = val;
        updateInputDisplay(val);
        calculateSchedule();
    }

    function handleManualInput() {
        let raw = parseInt(timeInput.value);
        if (isNaN(raw)) { updateInputDisplay(totalSessionGoal); return; }
        if (raw < 5) raw = 5;
        if (raw > MAX_MINUTES) raw = MAX_MINUTES;
        totalSessionGoal = raw;
        updateInputDisplay(raw);
        calculateSchedule();
    }

    // --- TIMER ---
    function toggleTimer() { if (isRunning) pause(); else start(); }

    function start() {
        if (timeLeft === 0 && currentStepIndex === 0 && !isRunning) loadBlock(0);
        isRunning = true;
        startBtn.innerText = "HALT";
        timeInput.disabled = true;
        protocolSelect.disabled = true; 
        document.getElementById('btnMinus').disabled = true;
        document.getElementById('btnPlus').disabled = true;
        updateStatusLabel();
        timerInterval = setInterval(tick, 1000);
    }

    function pause() {
        clearInterval(timerInterval);
        isRunning = false;
        startBtn.innerText = "RESUME";
        statusLabel.innerText = "OPERATION PAUSED";
        statusLabel.style.color = "#666";
        document.title = "Paused | Focus";
    }

    function resetSession() {
        clearInterval(timerInterval);
        
        const hands = document.querySelectorAll('.hand');
        hands.forEach(h => h.style.transition = 'none');
        setHands(0);
        void handSec.offsetWidth;
        hands.forEach(h => h.style.transition = '');

        isRunning = false;
        currentStepIndex = 0;
        timeLeft = 0;
        
        updateInputDisplay(totalSessionGoal);
        timeInput.disabled = false;
        protocolSelect.disabled = false;
        document.getElementById('btnMinus').disabled = false;
        document.getElementById('btnPlus').disabled = false;
        
        startBtn.innerText = "ENGAGE";
        skipBtn.style.display = "none";
        statusLabel.innerText = "TOTAL AVAILABLE TIME";
        statusLabel.style.color = "#8a1c1c";
        
        calculateSchedule(); 
        timeInput.style.color = "#000000";
        handSec.style.stroke = "#8a1c1c";
        document.title = "Focus Session | The Chronometer";
    }

    function loadBlock(index) {
        currentStepIndex = index;
        let step = schedule[index];
        currentBlockDuration = step.duration;
        timeLeft = step.duration * 60;
        
        const hands = document.querySelectorAll('.hand');
        hands.forEach(h => h.style.transition = 'none');
        setHands(0);
        void handSec.offsetWidth;
        hands.forEach(h => h.style.transition = '');

        updateStatusLabel();
        
        if (step.type === 'break') {
            skipBtn.style.display = "inline-block";
            // Dark Green for readability against white background
            timeInput.style.color = "#006400"; 
            handSec.style.stroke = "#006400";
            statusLabel.style.color = "#006400";
        } else {
            skipBtn.style.display = "none";
            // Black for focus
            timeInput.style.color = "#000000"; 
            handSec.style.stroke = "#8a1c1c";
            statusLabel.style.color = "#8a1c1c";
        }
    }

    function updateStatusLabel() {
        let step = schedule[currentStepIndex];
        let totalSteps = schedule.filter(s => s.type === step.type).length;
        let currentTypeIndex = 0;
        for(let i=0; i<=currentStepIndex; i++) {
            if(schedule[i].type === step.type) currentTypeIndex++;
        }

        if (step.type === 'focus') {
            statusLabel.innerText = `PHASE: CONCENTRATION (${currentTypeIndex}/${totalSteps})`;
        } else {
            statusLabel.innerText = `PHASE: RECOVERY (${currentTypeIndex}/${totalSteps})`;
        }
    }

    function tick() {
        if (timeLeft > 0) {
            timeLeft--;
            let elapsed = (currentBlockDuration * 60) - timeLeft;
            setHands(elapsed);
            timeInput.value = formatTime(timeLeft);
            let type = schedule[currentStepIndex].type;
            document.title = `(${formatTime(timeLeft)}) ` + (type === 'break' ? "Break" : "Focus");
        } else {
            completeBlock();
        }
    }

    function completeBlock() {
        const sound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        sound.play().catch(e => {});
        let step = schedule[currentStepIndex];
        if (step.type === 'focus') {
            totalMinutesLogged += step.duration;
            localStorage.setItem('dailyFocusTime', totalMinutesLogged);
            updateDailyVisuals();
        }
        if (currentStepIndex < schedule.length - 1) {
            loadBlock(currentStepIndex + 1);
        } else {
            finishEntireSession();
        }
    }

    function finishEntireSession() {
        clearInterval(timerInterval);
        isRunning = false;
        statusLabel.innerText = "SESSION COMPLETE";
        startBtn.innerText = "NEW TASK";
        setHands(0); 
        timeInput.value = "DONE";
        currentStepIndex = 0; timeLeft = 0;
    }

    function skipBreak() { if (schedule[currentStepIndex].type === 'break') completeBlock(); }
    function loadStats() {
        const saved = localStorage.getItem('dailyFocusTime');
        if (saved) totalMinutesLogged = parseInt(saved);
        updateDailyVisuals();
    }
    function updateDailyVisuals() {
        dailyText.innerText = totalMinutesLogged + " MIN";
        const percent = Math.min(100, (totalMinutesLogged / DAILY_GOAL) * 100);
        dailyBar.style.width = percent + "%";
    }

    init();
</script>

</body>
</html>